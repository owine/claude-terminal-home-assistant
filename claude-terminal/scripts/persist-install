#!/bin/bash

# User-friendly command for installing packages persistently
# Usage: persist-install python git vim

PERSIST_ROOT="/data/packages"
PERSIST_BIN="$PERSIST_ROOT/bin"
PERSIST_PYTHON="$PERSIST_ROOT/python"

show_help() {
    cat << EOF
üîß Persistent Package Installer

Install packages that survive container restarts!

USAGE:
    persist-install <package1> [package2] [...]
    persist-install --python <package1> [package2] [...]
    persist-install --ha-cli
    persist-install --list
    persist-install --help

EXAMPLES:
    persist-install git vim htop          # Install system packages
    persist-install --python requests pandas  # Install Python packages
    persist-install --ha-cli              # Install Home Assistant CLI
    persist-install --list                # Show installed packages

NOTES:
    ‚Ä¢ Packages are installed to: /data/packages (persistent storage)
    ‚Ä¢ Survives container restarts and reboots
    ‚Ä¢ System packages copied from Alpine APK
    ‚Ä¢ Python packages installed to virtual environment
    ‚Ä¢ Home Assistant CLI downloaded from official GitHub releases

QUICK START:
    1. persist-install python3 py3-pip    # Install Python (first time)
    2. persist-install --ha-cli           # Install official HA CLI
    3. Reboot and enjoy! Packages will still be there!

EOF
}

list_packages() {
    echo "=== üì¶ Persistent Packages ==="
    echo ""
    echo "üìÅ Location: $PERSIST_ROOT"
    echo ""

    echo "üîß System Binaries ($PERSIST_BIN):"
    if [ -d "$PERSIST_BIN" ] && [ "$(ls -A $PERSIST_BIN 2>/dev/null)" ]; then
        ls -1 "$PERSIST_BIN" | sed 's/^/  ‚Ä¢ /'
    else
        echo "  (none installed)"
    fi
    echo ""

    echo "üêç Python Packages ($PERSIST_PYTHON/venv):"
    if [ -f "$PERSIST_PYTHON/venv/bin/pip" ]; then
        source "$PERSIST_PYTHON/venv/bin/activate"
        pip list --format=columns | tail -n +3 | sed 's/^/  ‚Ä¢ /'
    else
        echo "  (virtual environment not created)"
        echo "  Run: persist-install python3 py3-pip"
    fi
    echo ""

    echo "üíæ Total size:"
    du -sh "$PERSIST_ROOT" 2>/dev/null || echo "  0B"
}

install_system_packages() {
    local packages="$@"

    echo "üì¶ Installing system packages: $packages"
    echo ""

    # Install via APK first
    echo "‚è≥ Installing via APK..."
    if ! apk add --no-cache $packages; then
        echo "‚ùå Failed to install packages"
        exit 1
    fi

    # Copy to persistent storage
    echo "üíæ Copying to persistent storage..."
    mkdir -p "$PERSIST_BIN" "$PERSIST_ROOT/lib"

    for pkg in $packages; do
        echo "  Processing: $pkg"

        # Get list of files installed by package
        apk info -L "$pkg" 2>/dev/null | while read -r file; do
            # Copy executables
            if [[ "$file" == /usr/bin/* ]] || [[ "$file" == /usr/sbin/* ]] || [[ "$file" == /bin/* ]]; then
                if [ -f "$file" ] && [ -x "$file" ]; then
                    cp -a "$file" "$PERSIST_BIN/" 2>/dev/null && echo "    ‚úì $(basename $file)"
                fi
            fi

            # Copy shared libraries
            if [[ "$file" == /usr/lib/* ]] && [[ "$file" == *.so* ]]; then
                if [ -f "$file" ]; then
                    cp -a "$file" "$PERSIST_ROOT/lib/" 2>/dev/null
                fi
            fi
        done
    done

    echo ""
    echo "‚úÖ System packages installed and persisted!"
    echo "üí° These packages will survive container restarts"
}

install_python_packages() {
    local packages="$@"

    echo "üêç Installing Python packages: $packages"
    echo ""

    # Ensure Python and venv exist
    if [ ! -f "$PERSIST_PYTHON/venv/bin/python" ]; then
        echo "‚ö†Ô∏è  Python virtual environment not found"
        echo "üì• Creating virtual environment..."

        # Check if system Python exists
        if ! command -v python3 &>/dev/null; then
            echo "‚ùå Python not installed. Installing..."
            install_system_packages python3 py3-pip
        fi

        mkdir -p "$PERSIST_PYTHON"
        python3 -m venv "$PERSIST_PYTHON/venv"
        echo "‚úÖ Virtual environment created"
        echo ""
    fi

    # Activate and install
    source "$PERSIST_PYTHON/venv/bin/activate"

    echo "‚è≥ Installing packages..."
    pip install --upgrade pip -q
    pip install $packages

    echo ""
    echo "‚úÖ Python packages installed!"
    echo "üí° Use 'source $PERSIST_PYTHON/venv/bin/activate' to activate venv"
}

install_ha_cli() {
    local HA_VERSION="4.42.0"
    local BASE_URL="https://github.com/home-assistant/cli/releases/download/${HA_VERSION}"

    # Detect architecture
    local machine=$(uname -m)
    local arch=""

    case "$machine" in
        x86_64)     arch="amd64" ;;
        aarch64)    arch="aarch64" ;;
        armv7l)     arch="armv7" ;;
        armv6l)     arch="armhf" ;;
        i386|i686)  arch="i386" ;;
        *)
            echo "‚ùå Unsupported architecture: $machine"
            return 1
            ;;
    esac

    local download_url="${BASE_URL}/ha_${arch}"
    local target_path="${PERSIST_BIN}/ha"

    echo "üè† Installing Home Assistant CLI v${HA_VERSION}"
    echo "üì¶ Architecture: ${arch}"
    echo ""

    # Check if already installed
    if [ -x "${target_path}" ]; then
        echo "‚ÑπÔ∏è  Home Assistant CLI is already installed"
        "${target_path}" --version
        return 0
    fi

    # Create directory
    mkdir -p "$PERSIST_BIN"

    # Download
    echo "‚è≥ Downloading from GitHub..."
    if ! curl -fsSL -o "${target_path}" "${download_url}"; then
        echo "‚ùå Failed to download ha CLI binary"
        return 1
    fi

    # Make executable
    chmod +x "${target_path}"

    # Verify file was downloaded and is executable
    if [ ! -x "${target_path}" ]; then
        echo "‚ùå Binary is not executable"
        rm -f "${target_path}"
        return 1
    fi

    # Check file size (should be > 1MB)
    local size=$(stat -f%z "${target_path}" 2>/dev/null || stat -c%s "${target_path}" 2>/dev/null || echo "0")
    if [ "$size" -lt 1000000 ]; then
        echo "‚ùå Downloaded file is too small (${size} bytes)"
        rm -f "${target_path}"
        return 1
    fi

    echo ""
    echo "‚úÖ Home Assistant CLI installed successfully!"
    echo "üì¶ Binary size: $((size / 1024 / 1024)) MB"
    echo "üìç Location: ${target_path}"
    echo ""

    # Try to get version (may fail if supervisor not accessible, but that's OK)
    echo "üîç Testing ha command..."
    if "${target_path}" --version 2>&1 | head -5; then
        echo ""
    else
        echo "‚ö†Ô∏è  Note: 'ha --version' returned an error, but the binary is installed."
        echo "   This is normal if supervisor API is not accessible yet."
        echo "   Try: ha core info"
    fi

    echo ""
    echo "üí° Try these commands:"
    echo "   ha core info"
    echo "   ha addons list"
    echo "   ha supervisor info"
}

# Main execution
main() {
    # Check if running in the app
    if [ ! -d "/data" ]; then
        echo "‚ùå Error: /data directory not found"
        echo "This script must run inside the Claude Terminal app"
        exit 1
    fi

    case "${1:-}" in
        --help|-h|help)
            show_help
            ;;
        --list|-l|list)
            list_packages
            ;;
        --python|-p|python)
            shift
            if [ $# -eq 0 ]; then
                echo "‚ùå Error: No packages specified"
                echo "Usage: persist-install --python <package1> [package2] ..."
                exit 1
            fi
            install_python_packages "$@"
            ;;
        --ha-cli|ha-cli|ha)
            install_ha_cli
            ;;
        "")
            show_help
            ;;
        *)
            install_system_packages "$@"
            ;;
    esac
}

main "$@"
